<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org" th:with="isEdit=${isEdit},adminOrganizationNavActive=${true},title=#{desktop.manager.title}">

<head th:substituteby="/includesTH :: head"></head>

<body>

<div class="container knappsack-container">

    <div th:substituteby="/includesTH :: header"/>

<div class="row">

<div th:substituteby="/includesTH :: side_menu"/>

<div class="span10">

<div class="page-info callout" th:if="${#bools.isTrue(isEdit)}"> <b class="notch"></b>
    <span class="page-info-bold" th:text="${#strings.append(organization.name,':')}"></span> <span th:text="#{desktop.manageOrganization.modifyInfo}">Modify the information for this organization.</span>
</div>

<div class="page-info callout" th:if="${#bools.isFalse(isEdit)}"> <b class="notch"></b>
    <span class="page-info-bold" th:text="#{desktop.manageOrganization.createOrg}">Create Organization:</span> <span th:text="#{desktop.manageOrganization.enterInfo}">Enter information for your new organization.</span>
</div>

<div class="content-wrap">
    <div class="container-fluid">

        <div class="row-fluid page-header first" style="border: none">

            <ul id="tab" class="nav nav-tabs">
                <li class="active dropdown tab">
                    <a href="#" th:text="#{desktop.manageOrganization.org}" th:if="${#bools.isFalse(isEdit)}">Organization</a>
                    <a id="organizationTab" href="#" class="dropdown-toggle" data-toggle="dropdown" th:inline="text" th:if="${#bools.isTrue(isEdit)}">
                        [[#{desktop.manageOrganization.org}]]
                        <b class="caret"/>
                    </a>
                    <ul class="dropdown-menu" th:if="${#bools.isTrue(isEdit)}">
                        <li><a id="view" href="#organization" data-toggle="tab" th:text="#{desktop.manageOrganization.view}">View</a></li>
                        <li class="divider" th:if="${user.systemAdmin}"></li>
                        <li><a href="manageDomainRegionsTH.html" id="manageRegions" th:href="@{'/manager/regions/' + ${organization.id}}" th:if="${isEdit}" th:text="#{desktop.manageOrganization.regions}">Manage Regions</a></li>
                        <li th:if="${user.systemAdmin}"><a id="preferences" href="domainConfigurationTH.html" th:href="@{/manager/domainConfiguration/}  + ${organization.id}" th:if="${isEdit}" th:text="#{desktop.manageOrganization.preferences}">Preferences</a></li>
                        <li th:if="${user.systemAdmin}"><a id="deleteOrg" th:text="#{desktop.organizations.delete}" th:if="${isEdit and #bools.isTrue(user.systemAdmin)}" href="#">Delete</a></li>
                    </ul>
                </li>

                <li th:if="${#bools.isTrue(isEdit)}" class="dropdown tab">
                    <a id="categoriesTab" class="dropdown-toggle" data-toggle="dropdown" href="#" th:inline="text">
                        [[#{desktop.manageOrganization.categories}]]
                        <b class="caret"/>
                    </a>
                    <ul id="categoriesDropdown" class="dropdown-menu">
                        <li><a id="viewCategories" href="#categories" data-toggle="tab" th:text="#{desktop.manageOrganization.view}">View</a></li>
                        <li class="divider"></li>
                        <li><a id="addCategory" href="manageCategoryTH.html" th:href="@{/manager/addCategory/}  + ${organization.id}" th:if="${isEdit}" th:text="#{desktop.manageOrganization.addCategory}">Add
                            Category</a></li>
                    </ul>

                </li>
                <li th:if="${#bools.isTrue(isEdit)}" class="dropdown tab">
                    <a id="membersTab" class="dropdown-toggle" data-toggle="dropdown" href="#" th:inline="text">
                        [[#{desktop.manageOrganization.members}]]
                        <b class="caret"/>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a id="viewMembers" href="#members" data-toggle="tab" th:text="#{desktop.manageOrganization.view}">View</a></li>
                        <li class="divider"></li>
                        <li><a id="inviteMember" href="inviteUserTH.html" th:href="@{/manager/inviteUser}" th:if="${isEdit}" th:text="#{desktop.manageOrganization.inviteMember}">Invite
                            Member</a></li>
                        <li><a href="inviteesTH.html" th:href="@{/manager/invitesPending/}  + ${organization.id}" th:if="${isEdit}" th:text="#{desktop.manageOrganization.invitesPending}">Invites Pending</a></li>
                        <li><a href="requestsTH.html" th:href="@{/manager/requestsPending/}  + ${organization.id}" th:if="${isEdit}" th:text="#{desktop.manageOrganization.requestsPending}">Requests Pending</a></li>
                    </ul>

                </li>
                <!--<li th:if="${#bools.isTrue(isEdit)}" class="tab"><a id="applicationsTab" href="#applications" data-toggle="tab" th:inline="text">[[#{desktop.manageOrganization.applications}]]-->
                    <!--<i-->
                        <!--id="applicationsTabAlertIcon" th:if="${#bools.isTrue(hasApplicationRequests)}"-->
                        <!--class="icon-exclamation-sign icon-black"/>-->
                <!--</a></li>-->
            </ul>

            <div class="tab-content">
                <div id="organization" class="tab-pane active">
                    <div class="row-fluid">
                        <div class="span7">
                            <form id="orgForm" th:object="${organization}" th:action="@{'/manager/uploadOrg'}" method="POST" enctype="multipart/form-data" class="form-horizontal">
                                <div id="errors" class="alert alert-error" th:if="${#fields.hasErrors('*')}">
                                    <h2 th:text="#{errors.header}">Errors</h2>
                                    <ul>
                                        <li th:each="err : ${#fields.errors('*')}" th:text="${err}">Input is incorrect</li>
                                    </ul>
                                </div>
                                <fieldset>
                                    <input type="hidden" id="id" name="id" th:value="*{id}"/>
                                    <input type="hidden" id="editing" name="editing" th:value="*{editing}"/>

                                    <div class="control-group">
                                        <label class="control-label" for="name"><span class="required">*</span> <span th:text="#{desktop.manageOrganization.name}">Name</span></label>

                                        <div class="controls">
                                            <input id="name" name="name" th:value="*{name}" autofocus="autofocus" required="required" type="text"/>
                                        </div>
                                    </div>

                                    <div class="control-group" th:if="${user.systemAdmin}">
                                        <label class="control-label" for="storageConfigurationId"><span class="required">*</span> <span th:text="#{desktop.manageOrganization.selectStorage}">Select Storage Method</span></label>

                                        <div class="controls">
                                            <select id="storageConfigurationId" name="storageConfigurationId" th:disabled="${#bools.isTrue(isEdit)}" required="required">
                                                <option value="" th:text="#{select.option.default}">--Please Select--</option>
                                                <option th:each="storageConfiguration : ${storageConfigurations}"
                                                        th:selected="*{storageConfigurationId} == ${storageConfiguration.id}"
                                                        th:value="${storageConfiguration.id}"
                                                        th:text="${storageConfiguration.name}"></option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="control-group" th:if="${user.systemAdmin}">
                                        <label class="control-label" for="storagePrefix"><span class="required">*</span> <span th:text="#{desktop.manageOrganization.storagePrefix}">Storage Prefix</span></label>

                                        <div class="controls">
                                            <input id="storagePrefix" type="text" th:field="*{storagePrefix}" required="required" th:readonly="${#bools.isTrue(isEdit)}"/>
                                        </div>
                                    </div>

                                    <div class="control-group" id="addLogoDiv" th:if="${#bools.isTrue(customBrandingEnabled)}">
                                        <label class="control-label" for="logoInput"><span th:text="#{desktop.manageOrganization.logo}">Logo</span></label>

                                        <div class="controls">
                                            <input id="logoInput" type="file" th:field="*{logo}" />
                                        </div>
                                    </div>

                                    <div class="control-group" id="deleteLogoDiv" th:if="${#bools.isTrue(isEdit)} and ${#bools.isTrue(customBrandingEnabled)}" style="display: none;">
                                        <div th:if="*{#bools.isTrue(logo)}">
                                            <label class="control-label" for="deleteLogo" th:text="#{desktop.manageOrganization.deleteLogo}">Delete Logo</label>
                                            <div class="controls">
                                                <a id="deleteLogo" class="btn btn-danger"><i class="icon-trash icon-white"></i>&nbsp;<span th:text="*{logo.name}">Name</span></a>
                                            </div>
                                        </div>
                                    </div>

                                    <!--<div class="control-group" th:if="${#bools.isTrue(customBrandingEnabled)}">-->
                                        <!--<label class="control-label" for="subdomain"><span th:text="#{desktop.manageOrganization.subdomain}">Subdomain</span></label>-->

                                        <!--<div class="controls">-->
                                            <!--<input id="subdomain" type="text" th:field="*{subdomain}" required="required"/>-->
                                        <!--</div>-->
                                    <!--</div>-->

                                    <div class="control-group" id="emailHeaderDiv" th:if="${#bools.isTrue(customBrandingEnabled)}">
                                        <label class="control-label" for="emailHeader"><span th:text="#{desktop.manageOrganization.emailHeader}">Email Header</span></label>
                                        <div class="controls">
                                            <textarea th:placeholder="#{desktop.manageOrganization.emailHeader.placeholder}" placeholder="Enter your custom email header here." id="emailHeader" th:field="*{emailHeader}" class="span8 textbox"></textarea>
                                        </div>
                                    </div>

                                    <div class="control-group" id="emailFooterDiv" th:if="${#bools.isTrue(customBrandingEnabled)}">
                                        <label class="control-label" for="emailFooter"><span th:text="#{desktop.manageOrganization.emailFooter}">Email Footer</span></label>
                                        <div class="controls">
                                            <textarea th:placeholder="#{desktop.manageOrganization.emailFooter.placeholder}" placeholder="Enter your custom email footer here." id="emailFooter" th:field="*{emailFooter}" class="span8 textbox"></textarea>
                                        </div>
                                    </div>

                                    <div class="form-actions">
                                        <button id="submitBtn" type="submit" class="btn btn-primary" th:text="#{desktop.manageOrganization.submit}">Submit</button>
                                    </div>

                                </fieldset>

                                <div class="alert alert-info">
                                    <span th:text="#{desktop.required.field.description(#{desktop.required.field})}">* indicates a required field</span>
                                </div>
                            </form>
                        </div>
                        <div class="span5">
                            <dl>
                                <dt th:text="#{desktop.manageOrganization.name}">Name</dt>
                                <dd th:text="#{desktop.manageOrganization.name.help}">This is the name of the organization that will be visible to users.</dd>
                                <dt th:text="#{desktop.manageOrganization.storageMethod}">Storage Method</dt>
                                <dd th:text="#{desktop.manageOrganization.storageMethod.help}">This is the name of the storage configuration you want to use to store files for this organization.</dd>
                                <dt th:text="#{desktop.manageOrganization.storagePrefix}">Storage Prefix</dt>
                                <dd th:text="#{desktop.manageOrganization.storagePrefix.help.1}">This is a prefix used to identify the base storage location. For example if the prefix is demo_org and the local path is /home/knappsack</dd>
                                <dd th:text="#{desktop.manageOrganization.storagePrefix.help.2}">then the path for this organization will be:</dd>
                                <dd th:text="#{desktop.manageOrganization.storagePrefix.help.3}">/home/knappsack/demo_org</dd>
                                <dt th:text="#{desktop.manageOrganization.logo}" th:if="${#bools.isTrue(customBrandingEnabled)}">Logo</dt>
                                <dd th:text="#{desktop.manageOrganization.logo.help}" th:if="${#bools.isTrue(customBrandingEnabled)}">A custom logo to be displayed for your organization. The logo must be a PNG or JPEG, at max 150 pixels (width) by 50 pixels (height) and less than 800 kilobytes.</dd>
                            </dl>
                        </div>
                    </div>
                    <div class="row-fluid" th:if="${domainStatistics != null}">
                        <div class="page-header">
                            <h1 th:text="#{desktop.manager.domainStatistics.statistics}">Statistics</h1>
                        </div>
                        <span style="display:block" th:text="#{desktop.manager.domainStatistics.totalUsers(${domainStatistics.totalUsers})}"></span>
                        <span style="display: block;"><span th:text="#{desktop.manager.domainStatistics.totalPendingInvitations(${domainStatistics.totalPendingInvitations})}"></span> <strong th:text="#{desktop.manager.domainStatistics.totalPendingInvitations.note}">Note: Pending invitations count towards your user total.</strong></span>
                        <span style="display:block" th:text="#{desktop.manager.domainStatistics.totalApplications(${domainStatistics.totalApplications})}"></span>
                        <span style="display:block" th:text="#{desktop.manager.domainStatistics.totalApplicationVersions(${domainStatistics.totalApplicationVersions})}"></span>
                        <span style="display:block" th:text="#{desktop.manager.domainStatistics.totalMegabyteStorageUsed(${#numbers.formatDecimal(domainStatistics.totalMegabyteStorageAmount,1,3)})}"></span>
                        <span style="display:block" th:text="#{desktop.manager.domainStatistics.totalMegabyteBandwidthUsed(${#numbers.formatDecimal(domainStatistics.totalMegabyteBandwidthUsed,1,3)})}"></span>
                    </div>
                </div>
                <div id="categories" class="tab-pane" th:if="${#bools.isTrue(isEdit)}">
                    <!--<div class="subnav">-->
                    <!--</div>-->
                    <h2 th:if="${#lists.isEmpty(categories)}" th:text="#{desktop.manageOrganization.noCategories}">There are currently no categories for this organization.</h2>
                    <table id="categoriesTable" cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered" th:if="${not #lists.isEmpty(categories)}">
                        <thead>
                        <tr>
                            <th th:text="#{desktop.manageOrganization.name}">Name</th>
                            <th th:text="#{desktop.manageOrganization.description}">Description</th>
                            <th th:text="#{desktop.manageOrganization.edit}">Edit</th>
                            <th th:text="#{desktop.manageOrganization.delete}">Delete</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="category : ${categories}">
                            <td th:text="${category.name}">1</td>
                            <td th:text="${category.description}" class="stripthml">My Name</td>
                            <td><a href="" th:href="@{'/manager/editCategory/' + ${category.id} + '/' + ${organization.id}}">Edit</a></td>
                            <td><a href="" th:href="@{'/manager/deleteCategory/' + ${category.id} + '/' + ${organization.id}}">Delete</a></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div id="members" class="tab-pane" th:if="${#bools.isTrue(isEdit)}">
                    <div class="row-fluid page-header">
                        <h1 th:text="#{desktop.manageOrganization.organizationMembers}">Organization Members</h1>

                        <p class="lead" th:text="#{desktop.manageOrganization.manageUsers}">
                            Manage the users who are currently members of this organization.
                        </p>

                        <div>
                            <div id="membersNavBar" style="margin-bottom: 9px;">
                                <button id="membersTableRemoveBtn" class="removeMembers btn btn-danger" href="" disabled="disabled" th:inline="text"><i class="icon-remove icon-white"/> [[#{desktop.manageOrganization.removeSelected}]]</button>
                            </div>
                            <table id="membersTable" cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered">
                                <thead>
                                <tr>
                                    <th><input type="checkbox" class="check-all"/></th>
                                    <th th:text="#{desktop.manageOrganization.name}">Name</th>
                                    <th th:text="#{desktop.manageOrganization.email}">Email</th>
                                    <th th:text="#{desktop.manageOrganization.role}">Role</th>
                                    <th th:text="#{desktop.manageOrganization.update}">Update</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <!--<p th:if="${#lists.isEmpty(organizationMembers)}" class="alert alert-info" th:text="#{desktop.manageOrganization.noMembers}">There are currently no members for this organization.</p>-->
                    </div>

                    <div class="row-fluid">
                        <h1 th:text="#{desktop.manageOrganization.organizationGuests}">Organization Guests</h1>
                        <p class="lead" th:text="#{desktop.manageOrganization.organizationGuests.help}">
                            This includes users who are members of a group but not the organization as a whole.
                        </p>

                        <div>
                            <table id="guestsTable" cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered">
                                <thead>
                                <tr>
                                    <th th:text="#{desktop.manageOrganization.name}">Name</th>
                                    <th th:text="#{desktop.manageOrganization.email}">Email</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <!--<p th:if="${#lists.isEmpty(organizationGuests)}" class="alert alert-info" th:text="#{desktop.manageOrganization.noGuests}">There are currently no guests for this organization.</p>-->
                    </div>
                </div>
                <!--<div id="applications" class="tab-pane" th:if="${#bools.isTrue(isEdit)}">-->
                    <!--&lt;!&ndash;<h2 th:if="${#lists.isEmpty(applicationVersions)}" th:text="#{desktop.manageOrganization.noApps}">There are currently no applications for this organization.</h2>&ndash;&gt;-->
                    <!--<table id="applicationsTable" cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered">-->
                        <!--<thead>-->
                        <!--<tr>-->
                            <!--<th th:text="#{desktop.manageOrganization.name}">Name</th>-->
                            <!--<th th:text="#{desktop.manageOrganization.applicationType}">Type</th>-->
                            <!--<th th:text="#{desktop.manageOrganization.description}">Description</th>-->
                            <!--<th th:text="#{desktop.manageOrganization.version}">Version</th>-->
                            <!--<th th:text="#{desktop.manageOrganization.group}">Group</th>-->
                            <!--<th th:text="#{desktop.manageOrganization.availability}">Availability</th>-->
                            <!--<th></th>-->
                        <!--</tr>-->
                        <!--</thead>-->
                        <!--<tbody>-->
                        <!--</tbody>-->
                    <!--</table>-->

                <!--</div>-->
            <!--</div>-->

        </div>
        </div>
    </div>
</div>

</div>
</div>

</div>

<div th:substituteBy="/includesTH :: confirmation_modal"></div>

<div id="appStateModal" class="modal hide fade" style="display: none;">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">x</a>
        <h3 th:text="#{desktop.manageOrganization.appVisibility}">Application Visibility</h3>
    </div>
    <div class="modal-body">
        <div class="alert alert-success" style="display: none;">
            <h2 th:text="#{desktop.manageOrganization.appUpdated}">The application was updated!</h2>
        </div>
        <div class="alert alert-error" style="display: none;">
            <h2 th:text="#{desktop.manageOrganization.error}">An error has occurred. Please try again.</h2>
        </div>
    </div>
    <div class="modal-footer">
        <a id="modalCancel" href="#" class="btn" data-dismiss="modal" th:text="#{desktop.manageOrganization.okay}">Okay</a>
    </div>
</div>

<footer th:substituteby="/includesTH :: footer"></footer>

<div th:substituteby="/includesTH :: scripts"/>

<script type="text/javascript" th:inline="javascript">
/*<![CDATA[*/

$(document).ready(function () {
    var recordsPerPage = /*[[#{desktop.table.records.per.page}]]*/ "records per page";
    var userId = /*[[${user} ? ${user.id} : 0]]*/ 0;
    var userRoles = /*[[${userRoles}]]*/ [];
//    var applicationTypes = /*[[${applicationTypes}]]*/ [];
//    var appStates = /*[[${appStates}]]*/ [];

    var getUsersForActiveOrganizationURL = /*[[@{/manager/getUsersForActiveOrganization(includeGuests=${false})}]]*/ '/manager/getUsersForActiveOrganization?includeGuests=false';
    var getGuestsForActiveOrganizationURL = /*[[@{/manager/getGuestsForActiveOrganization}]]*/ '/manager/getGuestsForActiveOrganization';
//    var getApplicationVersionsForActiveOrganizationURL = /*[[@{/manager/getApplicationVersionsForActiveOrganization(includeInstallFile=${false})}]]*/ '/manager/getApplicationVersionsForActiveOrganization?includeInstallFile=false';

    var $membersTable;
    var $guestsTable;
    $('a[data-toggle="tab"][href="#members"]').on('show', function(e) {
        if (!$membersTable) {
            $membersTable = $('#membersTable').dataTable( {
                "sDom": "<'table-inline'<<'span6'l><'pull-right'f>r>t<<'span6'i><'pull-right'p>>>",
                "sPaginationType": "bootstrap",
                "oLanguage": {
                    "sLengthMenu": "_MENU_ " + recordsPerPage
                },
                "sAjaxSource": getUsersForActiveOrganizationURL,
                "sAjaxDataProp":"",
                "bProcessing": true,
                "aoColumnDefs": [
                    {
                        "aTargets" : [0],
                        "sDefaultContent" : false,
                        "bSortable" : false,
                        "mRender" : function(data, type, full) {
                            var $input =  $('<input>').addClass('check').attr('type', 'checkbox').data('user-id', full.user.id);
                            if (full.user.id == userId) {
                                $input.attr('disabled', 'disabled');
                            }
                            return $input.wrapAll('<div>').parent().html();
                        }
                    },
                    {
                        "aTargets" : [1],
                        "mData" : "user.fullName",
                        "sDefaultContent" : /*[[#{notApplicable}]]*/ 'N/A',
                        "bSortable" : true
                    },
                    {
                        "aTargets" : [2],
                        "mData" : "user.email",
                        "sDefaultContent" : /*[[#{notApplicable}]]*/ 'N/A',
                        "bSortable" : true
                    },
                    {
                        "sSortDataType": "dom-select",
                        "aTargets" : [3],
                        "mData" : "userRole",
                        "sType" : "string",
                        "bSortable" : true,
                        "mRender" : function(data, type, full) {
                            var $select = $('<select>').addClass('userrole-select');
                            if (full.user.id == userId) {
                                $select.attr('disabled', 'disabled');
                            }
                            $(userRoles).each(function(index, value) {
                                var $option = $('<option>').val(value.key.$name).text(value.value);
                                if (data == value.key.$name) {
                                    $option.attr('selected', true);
                                }
                                $select.append($option.wrapAll('<div>').parent().html());
                            });
                            return $select.wrapAll('<div>').parent().html();;
                        }
                    },
                    {
                        "aTargets" : [4],
                        "bSortable" : false,
                        "sDefaultContent" : '',
                        "mRender" : function(data, type, full) {
                            var btnText = /*[[#{desktop.manageOrganization.update}]]*/ 'Update';
                            var $button = $('<button>').addClass('updateMember').text(btnText);
                            if (full.user.id == userId) {
                                $button.attr('disabled', 'disabled');
                            }
                            return $button.wrapAll('<div>').parent().html();
                        }
                    }
                ],
                "fnCreatedRow" : function(nRow, aData, iDataIndex) {
                    $(nRow).data('user-id', aData.user.id);
                }
            });

            $('#membersTableRemoveBtn').data('table', $membersTable);
            $('#membersTable').data('table', $membersTable);

            $guestsTable = $('#guestsTable').dataTable( {
                "sDom": "<'table-inline'<<'span6'l><'pull-right'f>r>t<<'span6'i><'pull-right'p>>>",
                "sPaginationType": "bootstrap",
                "oLanguage": {
                    "sLengthMenu": "_MENU_ " + recordsPerPage
                },
                "sAjaxSource": getGuestsForActiveOrganizationURL,
                "sAjaxDataProp":"",
                "bProcessing": true,
                "aoColumnDefs": [
                    {
                        "aTargets" : [0],
                        "bSortable" : true,
                        "sDefaultContent" : /*[[#{notApplicable}]]*/ 'N/A',
                        "mData" : "user.fullName"
                    },
                    {
                        "aTargets" : [1],
                        "bSortable" : true,
                        "sDefaultContent" : /*[[#{notApplicable}]]*/ 'N/A',
                        "mData" : "user.email"
                    }
                ],
                "fnCreatedRow" : function(nRow, aData, iDataIndex) {
                    $(nRow).data('user-id', aData.user.id);
                }
            });

            $('#guestsTableRemoveBtn').data('table', $guestsTable);
            $('#guestsTable').data('table', $guestsTable);
        }
    });
    $(this).tabState('#organization');

    var isEdit = /*[[${isEdit}]]*/ false;
    var tmpOptions = {};
    var successFunction;
    var tmpSelectedRows = [];
    var organizationId = /*[[${organization.id}]]*/ '';

    if (isEdit) {
        var logoExists = /*[[${#bools.isTrue(organization.logo)}]]*/ false;
        if (logoExists) {
            $('#addLogoDiv').hide();
            $('#deleteLogoDiv').show();
        }
    }

    $('.striphtml').striphtml();

    $('#categoriesTable').dataTable( {
        "sDom": "<'table-inline'<<'span6'l><'pull-right'f>r>t<<'span6'i><'pull-right'p>>>",
        "sPaginationType": "bootstrap",
        "oLanguage": {
            "sLengthMenu": "_MENU_ " + recordsPerPage
        },
        "aoColumns": [
            null,
            null,
            { "bSortable": false },
            { "bSortable": false }
        ]
    });

    $('#emailHeader').wysihtml5({
        customTemplates: ks.wysihtml5.customTemplates,
        "font-styles": false, //Font styling, e.g. h1, h2, etc. Default true
        "image": false, //Button to insert an image. Default true,
        "color": false, //Button to change color of font
        "stylesheets": false
    });

    $('#emailFooter').wysihtml5({
        customTemplates: ks.wysihtml5.customTemplates,
        "font-styles": false, //Font styling, e.g. h1, h2, etc. Default true
        "image": false, //Button to insert an image. Default true,
        "color": false, //Button to change color of font
        "stylesheets": false
    });

//    $('#applicationsTable').dataTable( {
//        "sDom": "<'table-inline'<<'span6'l><'pull-right'f>r>t<<'span6'i><'pull-right'p>>>",
//        "sPaginationType": "bootstrap",
//        "oLanguage": {
//            "sLengthMenu": "_MENU_ " + recordsPerPage
//        },
//        "sAjaxSource": getApplicationVersionsForActiveOrganizationURL,
//        "sAjaxDataProp":"",
//        "bProcessing": true,
//        "aoColumnDefs": [
//            {
//                "aTargets" : [0],
//                "mData" : "application.name",
//                "sType" : "string",
//                "bSortable" : true,
//                "mRender" : function(data, type, full) {
//                    var $anchor = $('<a>').attr('href', ks.contextPath + '/manager/editApplication/' + full.application.id).attr('title', data).text(data);
//                    return $anchor.wrapAll('<div>').parent().html();
//                }
//            },
//            {
//                "aTargets" : [1],
//                "mData" : "application.applicationType",
//                "bSortable" : true,
//                "mRender" : function(data, type, full) {
//                    var appTypeMessage = data;
//                    $(applicationTypes).each(function(index, value) {
//                        if ($(this).key.$name == data) {
//                            appTypeMessage = $(this).value;
//                            return;
//                        }
//                    });
//                    return appTypeMessage;
//                }
//            },
//            {
//                "aTargets" : [2],
//                "mData" : "application.description",
//                "bSortable" : true,
//                "mRender" : function(data, type, full) {
//                    return ks.striphtml(data);
//                }
//            },
//            {
//                "aTargets" : [3],
//                "mData" : "versionName",
//                "sType" : "string",
//                "bSortable" : true,
//                "mRender" : function(data, type, full) {
//                    var $anchor = $('<a>').attr('href', ks.contextPath + '/manager/editVersion/' + full.application.id + '/' + full.id).attr('title', data).text(data);
//                    return $anchor.wrapAll('<div>').parent().html();
//                }
//            },
//            {
//                "aTargets" : [4],
//                "mData" : "application.ownedGroup.name",
//                "sType" : "string",
//                "bSortable" : true,
//                "mRender" : function(data, type, full) {
//                    var $anchor = $('<a>').attr('href', ks.contextPath + '/manager/editGroup/' + full.application.ownedGroup.id).attr('title', data).text(data);
//                    return $anchor.wrapAll('<div>').parent().html();
//                }
//            },
//            {
//                "sSortDataType": "dom-select",
//                "aTargets" : [5],
//                "mData" : "appState",
//                "sType" : "string",
//                "bSortable" : true,
//                "mRender" : function(data, type, full) {
//                    var $select = $('<select>').addClass('appstate-select').attr('required', 'required');
//                    $(appStates).each(function(index, value) {
//                        if ((data.userSelectable && data.availableToOrganization) || data == value.key.$name) {
//                            var $option = $('<option>').val(value.key.$name).text(value.value);
//                            if (data == value.key.$name) {
//                                $option.attr('selected', true);
//                            }
//
//                            if (!data.availableToOrganization) {
//                                $option.attr('disabled', 'disabled');
//                            }
//                            $select.append($option.wrapAll('<div>').parent().html());
//                        }
//                    });
//                    return $select.wrapAll('<div>').parent().html();;
//                }
//            },
//            {
//                "aTargets" : [4],
//                "bSortable" : false,
//                "sDefaultContent" : '',
//                "mRender" : function(data, type, full) {
//                    var btnText = /*[[#{desktop.manageOrganization.update}]]*/ 'Update';
//                    var $button = $('<button>').addClass('updateAppState').text(btnText);
//                    return $button.wrapAll('<div>').parent().html();
//                }
//            }
//        ],
//        "fnCreatedRow" : function(nRow, aData, iDataIndex) {
//            $(nRow).data('app-ver-id', aData.id);
//        }
//    });

//    function ajaxSubmit(dataSet) {
//        var url = /*[[@{/manager/updateAppVersionState}]]*/ '/manager/updateAppVersionState';
//        $.ajax({url:url, data:dataSet, success:function(data) {
//            if (data.result) {
//                $('#appStateModal .modal-body .alert-error').hide();
//                $('#appStateModal .modal-body .alert-success').show();
//                $('#appStateModal').modal('show');
//            } else {
//                $('#appStateModal .modal-body .alert-error').show();
//                $('#appStateModal .modal-body .alert-success').hide();
//                $('#appStateModal').modal('show');
//            }
//        }});
//    }
//
//    $('#applicationsTable').on('click', '.updateAppState', function() {
//        var row = $(this).closest('tr').get(0);
//        var appVerId = $(row).data('app-ver-id');
//        var appStateVal = $(row).children('td.select-td').children('select').val();
//        var dataSet = { appVersionId:appVerId, appState:appStateVal };
//
//        ajaxSubmit(dataSet);
//    });

    $('#membersTable').on('click', '.updateMember', function() {
        var row = $(this).closest('tr').get(0);
        var userId = $(row).data('user-id');
        var userRole = $(row).find('select.userrole-select option:selected').val();
        tmpOptions = { orgId : organizationId, userId : userId, userRole : userRole };

        showConfirmationModal('Update Member Role');
        $('#confirmationModalSubmit').on('click', function () {
            var url = /*[[@{/manager/updateOrgMemberRole}]]*/ '/manager/updateOrgMemberRole';
            ajaxMemberUpdateSubmit(url);
        });

        successFunction = function() {
        };
    });

    function showConfirmationModal(title) {
        $('#confirmationModal .modal-header h3').text(title);
        $('#confirmationModal').modal();
    }

    function hideModal(delay) {
        setTimeout(function () {
                    $('.modal').modal('hide');
                }, delay
        );
    }

    $('#confirmationModal').on('show', function () {
        $('#confirmationModal .modal-body .alert').hide();
        $('#confirmationModal .modal-footer .btn').removeAttr('disabled');
        $('#confirmationModal .close').removeAttr('disabled');
    });

    $('#confirmationModal').on('hide', function () {
        $('#confirmationModalSubmit').unbind('click');
        tmpOptions = {};
        successFunction = '';
    });

    function ajaxMemberUpdateSubmit(url) {
        $.ajax({ url:url, data:tmpOptions, success:function(data) {
            if (data.result) {
                $('#confirmationModal .modal-body .alert-error').hide();
                $('#confirmationModal .modal-body .alert-success').show();
                successFunction();
                hideModal(500);
            } else {
                $('#confirmationModal .modal-body .alert-error').show();
                $('#confirmationModal .modal-footer .btn').removeAttr('disabled');
                $('#confirmationModal .close').removeAttr('disabled');
            }
        }
        });
    }

    $('#membersTable').on('click', '.check-all', function() {
        var checked = $(this).attr('checked');

        var $dataTable = $(this).closest('table').data('table');

        $dataTable.$('td :checkbox:not(:disabled)').each(function () {
            if (checked) {
                $(this).attr('checked', 'checked');
                $(this).closest('tr').addClass('row_selected');
            } else {
                $(this).removeAttr('checked');
                $(this).closest('tr').removeClass('row_selected');
            }
        });

        checkButtonState($dataTable, $('#membersTableRemoveBtn'));
    });

    $('#membersTable').on('click', '.check', function() {
        var checked = $(this).attr('checked');

        if (checked) {
            $(this).closest('tr').addClass('row_selected');
        } else {
            $(this).closest('tr').removeClass('row_selected');
        }

        checkButtonState($membersTable, $('#membersTableRemoveBtn'));
    });

    $('.removeMembers').on('click', function (event) {
        event.preventDefault();
        var memberIdsToRemove = [];

        var data = $membersTable.$('tr.row_selected');

        $(data).each(function () {
            memberIdsToRemove.push($(this).data('user-id'));
            tmpSelectedRows.push(this);
        });

        tmpOptions = { organizationId:organizationId, userIds:memberIdsToRemove };
        showConfirmationModal('Remove Member');
        $('#confirmationModalSubmit').click(function () {
            ajaxRemoveMemberSubmit($membersTable);
        });
    });

    function ajaxRemoveMemberSubmit(dataTable) {
        $('#confirmationModal .modal-footer .btn').attr('disabled', 'disabled');
        $('#confirmationModal .close').attr('disabled', 'disabled');
        var url = /*[[@{/manager/removeOrganizationUsers}]]*/ '/manager/removeOrganizationUsers';
        $.ajax({
            url:url,
            data:tmpOptions,
            type:"POST",
            success:function(data) {
                $(tmpSelectedRows).each(function() {
                    var row = this;
                    $(data.value).each(function(index, value) {
                        if (value == $(row).data('user-id')) {
                            dataTable.fnDeleteRow(row);
                        }
                    });
                });

                tmpOptions = {};
                tmpSelectedRows = [];

                if (data.result) {
                    $('#confirmationModal .modal-body .alert-error').hide();
                    $('#confirmationModal .modal-body .alert-success').show();
                    hideModal(500);
                }
                else {
                    $('#confirmationModal .modal-body .alert-error').show();
                    $('#confirmationModal .modal-footer .btn').removeAttr('disabled');
                    $('#confirmationModal .close').removeAttr('disabled');

                    var userIdsToRemove = [];
                    dataTable.$('tr.row_selected').each(function () {
                        userIdsToRemove.push($(this).data('user-id'));
                        tmpSelectedRows.push(this);
                    });
                    tmpOptions = { organizationId:organizationId, userIds:userIdsToRemove };
                }
            }
        });
    }

    function checkButtonState(dataTable, button) {
        if (!dataTable || !button) {
            return;
        }

        var checkedLength = dataTable.$('td :checkbox:checked').length;

        if (checkedLength > 0) {
            $(button).removeAttr('disabled');
        } else {
            $(button).attr('disabled', 'disabled');
        }
    }

    $('#deleteLogo').on('click', function(e) {
        deleteLogoEvent(e);
    });

    var deleteLogoEvent = function(e) {
        e.preventDefault();

        var title = /*[[#{desktop.manageOrganization.logo.deleteConfirmation.title}]]*/ 'Delete Logo';
        var data = { 'title' : title };
        showModal("#confirmationModal", data, fnOnDeleteLogoConfirmationModalShow, fnOnDeleteLogoConfirmationModalHide);
    }

    var fnOnDeleteLogoConfirmationModalShow = function(data) {
        var deleteGroupUrl = /*[[@{/manager/deleteOrgLogo}]]*/ '/manager/deleteOrgLogo';
        $('.modal-header h3', '#confirmationModal').text(data.title);
        $('#confirmationModalSubmit').off('click');
        $('#confirmationModalSubmit').on('click', function(e) {
            $.post(deleteGroupUrl, {"id":organizationId}, function(result) {
                if (result.result) {
                    $('#confirmationModal .modal-body .alert-error').hide();
                    $('#confirmationModal .modal-body .alert-success').show();
                    $('#customLogo').remove();
                    $('#poweredByKnappsack').remove();
                    $('#defaultLogo').show();
                    $('#deleteLogoDiv').remove();
                    $('#addLogoDiv').show();
                    hideModal(500);
                } else {
                    $('#confirmationModal .modal-body .alert-error').show();
                    $('#confirmationModal .modal-footer .btn').removeAttr('disabled');
                    $('#confirmationModal .close').removeAttr('disabled');
                }
            });
        });
    }

    var fnOnDeleteLogoConfirmationModalHide = function() {
        $('#confirmationModal .modal-body .alert').hide();
        $('#confirmationModal .modal-footer .btn').removeAttr('disabled');
        $('#confirmationModal .close').removeAttr('disabled');
    };

    function showModal(id, data, fnOnShow, fnOnHide) {
        if (id.substr(0, 1) !== '#') {
            id = '#' + id;
        }

        $(id).off('show');
        $(id).on('show', fnOnShow(data));

        $(id).off('hidden');
        $(id).on('hidden', fnOnHide());

        $(id).modal();
    }

    function hideModal(delay) {
        setTimeout(function () {
                    $('.modal').modal('hide');
                }, delay
        );
    }


    $("#deleteOrg").on("click", function() {

        var title = /*[[#{desktop.organizations.deleteConfirmation.title}]]*/ 'Delete Organization';
        var orgId = /*[[${organization.id}]]*/ '0';
        var data = { 'title' : title, 'orgId' : orgId}
        showModal("#confirmationModal", data, fnOnDeleteOrgConfirmationModalShow, fnOnDeleteOrgConfirmationModalHide);
    });

    var fnOnDeleteOrgConfirmationModalShow = function(data) {
        var deleteOrgUrl = /*[[@{/manager/deleteOrg}]]*/ '/manager/deleteOrg';
        $('.modal-header h3', '#confirmationModal').text(data.title);
        $('#confirmationModalSubmit').off('click');
        $('#confirmationModalSubmit').on('click', function(e) {
            $.post(deleteOrgUrl, {"id":data.orgId}, function(result) {
                if (result.result) {
                    $('#confirmationModal .modal-body .alert-error').hide();
                    $('#confirmationModal .modal-body .alert-success').show();
                    hideModal(500);
                } else {
                    $('#confirmationModal .modal-body .alert-error').show();
                    $('#confirmationModal .modal-footer .btn').removeAttr('disabled');
                    $('#confirmationModal .close').removeAttr('disabled');
                }
            });
        });
    }

    var fnOnDeleteOrgConfirmationModalHide = function() {
        $('#confirmationModal .modal-body .alert').hide();
        $('#confirmationModal .modal-footer .btn').removeAttr('disabled');
        $('#confirmationModal .close').removeAttr('disabled');
    };
});
/*]]>*/
</script>

</body>
</html>